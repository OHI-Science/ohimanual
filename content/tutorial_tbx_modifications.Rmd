---
title: "Modifying a goal model with the OHI Toolbox"
output: ioslides_presentation
---

## Outline

* Introduction to WebApps
* Explore an Assessment Repository
* Modify the AO goal model by adding a variable to global model
    + create new data layer
    + save and register the data layer
    + modify the goal model
    + run the Toolbox and explore differences

## Introduction to WebApps

Let's look at an example for Belize: http://ohi-science.org/blz.

WebApp tabs: 

* [App](http://ohi-science.org/blz/app): interactive to explore data and scores
* [Regions](http://ohi-science.org/blz/regions/): Belize has 4
* [Layers](http://ohi-science.org/blz/layers/): alphabetical list of all data
* [Goals](http://ohi-science.org/blz/goals/): global goal model equations
* [Scores](http://ohi-science.org/blz/scores/): calculated based on extracted global data


## Explore an Assessment Repository

Belize's **assessment repository** is **blz**, available on GitHub at https://github.com/OHI-Science/blz.  
  
The **scenario folder** is **subcountry2014**. 

Note the `blz.Rproj` file that allows you to sync this repository through RStudio.

## Explore an Assessment Repository

Within the **subcountry2014** folder are some key files we will work with:

* **layers.csv**
* **layers folder**
* **conf/functions.r**
* **conf/goals.csv**
* **conf/pressures_matrix.csv**
* **conf/resilience_matrix.csv**
 
## Create a new variable and add it to a goal model 

Assume your team has decided the global model can be modified by adding a new variable.

Steps: 

1. Modify or create data layer with proper formatting
2. Save the layer in the `layers` folder
3. Register the layer in `layers.csv`
4. Update `functions.r`
5. Check and possibly update `goals.csv`
6. Check the pressures and resilience matrices


## AO global model

AO global model variables: need, access, and sustainability. 

$$
D_{U} = (1 - P) * (1 - O_{AO})
$$
$$
x_{AO} = (1 - D_{U}) * S_{AO};
$$

<small>$D_{U}$ = unmet demand</small>;  
<small>$P$ = need (PPP-adjusted per capita GDP);</small>  
<small>$O_{AO}$ = access to artisanal fishing;</small>  
<small>$S_{AO}$ = sustainability of fishing methods</small>   

## AO global model

AO global model variables: need, access, and sustainability. 


$$
D_{U} = (1 - P) * (1 - O_{AO})
$$
$$
x_{AO} = (1 - D_{U}) * S_{AO};
$$

The way this looks like in [`functions.r`](https://github.com/OHI-Science/ecu/blob/028ead581c5dade039941b1aa3524220c454e431/subcountry2014/conf/functions.R#L425-L429)  

```
 # model
  ry = within(ry,{
    Du = (1.0 - need) * (1.0 - access)
    statusData = ((1.0 - Du) * Sustainability)
  })
```


## AO updated model: what we want

A simple example of a modified goal model: include a second measure of access


$$
D_{U} = (1 - P) * (1 - (O_{AO} + O_{art})/2 )
$$
$$
x_{AO} = (1 - D_{U}) * S_{AO};
$$

The way this looks like in [`functions.r`](https://github.com/OHI-Science/blz/blob/9cf957f272e784f557eb75a3a9e5bf7b4677d5d5/subcountry2014/conf/functions.R#L407-L461)  

```
 # model
  ry = within(ry,{
    Du = (1.0 - need) * (1.0 - (access + access_art)/2 )
    statusData = ((1.0 - Du) * Sustainability)
  })
```

## many other slides



## Update AO model in `functions.r` 


```
 layers_data = SelectLayersData(layers, targets='AO')
  
  ry = rename(dcast(layers_data, id_num + year ~ layer, value.var='val_num', 
                    subset = .(layer %in% c('ao_need'))),
              c('id_num'='region_id', 'ao_need'='need')); head(ry); summary(ry)
  
  r = na.omit(rename(dcast(layers_data, id_num ~ layer, value.var='val_num', 
                           subset = .(layer %in% c('ao_access'))),
                     c('id_num'='region_id', 'ao_access'='access'))); head(r); summary(r)
                     
  ra = na.omit(rename(dcast(layers_data, id_num ~ layer, value.var='val_num', 
                           subset = .(layer %in% c('ao_access_art'))),
                     c('id_num'='region_id', 'ao_access_art'='access_art'))); head(ra); summary(ra)
  
  ry = merge(ry, r); 
  ry = merge(ry, ra); head(ry); summary(ry); dim(ry)
 
 # model
  ry = within(ry,{
    Du = (1.0 - need) * (1.0 - (access + access_art)/2 )
    statusData = ((1.0 - Du) * Sustainability)
  })
```

