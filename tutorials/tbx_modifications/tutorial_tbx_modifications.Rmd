---
title: "Using the OHI Toolbox: Modifying a goal model"
output: ioslides_presentation
---

## Steps to create a new variable and add it to a goal model 

Assume your team has decided the global AO model can be modified by adding a new variable.

Steps: 

1. Review global AO model
2. Prepare data layer & save in the `layers` folder
3. Register the layer in `layers.csv`
4. Update goal model in `functions.r`
5. Check and possibly update `goals.csv`
6. Calculate scores; view with WebApp


## Step 1: Review AO global model

AO global model variables: need, access, and sustainability. 

$$
D_{U} = (1 - P) * (1 - O_{AO})
$$
$$
x_{AO} = (1 - D_{U}) * S_{AO}
$$

<small>$D_{U}$ = unmet demand</small>  
<small>$P$ = need (PPP-adjusted per capita GDP)</small>  
<small>$O_{AO}$ = access to artisanal fishing</small>  
<small>$S_{AO}$ = sustainability of fishing methods</small>   

## Step 1: Review AO global model

AO global model variables: need, access, and sustainability. 

$$
D_{U} = (1 - P) * (1 - O_{AO})
$$
$$
x_{AO} = (1 - D_{U}) * S_{AO}
$$

The way this looks like in [`functions.r`](https://github.com/OHI-Science/ecu/blob/028ead581c5dade039941b1aa3524220c454e431/subcountry2014/conf/functions.R#L425-L429):  

```
    Du = (1.0 - need) * (1.0 - access)
    statusData = ((1.0 - Du) * Sustainability)
```

## Step 1: Plan AO global model

Let's say we have data available about poverty in Belize, which can be incorporated as part of need (the global model is based on need and access).

## Step 1: Plan AO global model

Let's say we have data available about poverty in Belize, which can be incorporated as part of need (the global model is based on need and access).

Let's incorporate a second measure of need called $P_{pov}$.


$$
D_{U} = (1 - (P + P_{pov}) / 2) * (1 - (O_{AO})
$$
$$
x_{AO} = (1 - D_{U}) * S_{AO}
$$

## Step 1: Plan AO global model

Let's say we have data available about poverty in Belize, which can be incorporated as part of need (the global model is based on need and access).

Let's incorporate a second measure of need called $P_{pov}$.


$$
D_{U} = (1 - (P + P_{pov}) / 2) * (1 - (O_{AO})
$$
$$
x_{AO} = (1 - D_{U}) * S_{AO}
$$

The way this looks like in [`functions.r`](https://github.com/OHI-Science/blz/blob/9cf957f272e784f557eb75a3a9e5bf7b4677d5d5/subcountry2014/conf/functions.R#L407-L461):  

```
    Du = (1.0 - (need + need_pov) / 2 ) * (1.0 - access)
    statusData = ((1.0 - Du) * Sustainability)
```

## Step 2: Prepare & save new data layer

### What do our new data look like?

* [Population by district](http://en.wikipedia.org/wiki/Districts_of_Belize)
* [Percent below poverty line for Belize](http://www.indexmundi.com/belize/population_below_poverty_line.html)

## Step 2: Prepare & save new data layer

### What do our new data look like?

* [Population by district](http://en.wikipedia.org/wiki/Districts_of_Belize)
* [Percent below poverty line for Belize](http://www.indexmundi.com/belize/population_below_poverty_line.html)  
  
  
### What do the existing data layers look like?

* **Explore using the blz WebApp**
    + http://ohi-science.org/blz/layers

* **Explore the blz repository**
    + [access](https://github.com/OHI-Science/blz/blob/draft/subcountry2014/layers/ao_access_gl2014.csv)
    + [need](https://github.com/OHI-Science/blz/blob/draft/subcountry2014/layers/ao_need_gl2014.csv)

## Step 2: Prepare & save new data layer

### Good practices

* **organize & prepare data in a github repository** (`github/blz-prep`)
* **document all metadata** (`README.md`s)
* **create a region-to-name lookup table** (`rgn_district_lookup.csv`)
* **script any data manipulations** (`prep_ao_need.r`)

## Step 2: Prepare & save new data layer

`prep_ao_need_pov.r` prepares the layer `ao_need_pov.csv`. 

* combines national percent poverty with population by district
* replaces district names with numeric identifiers (rgn_district_lookup.csv)

| rgn_id| year|   percent|
|------:|----:|---------:|
|      1| 2010| 0.0557542|
|      2| 2010| 0.1233978|
|      3| 2010| 0.0444745|
|      4| 2010| 0.0422235|

## Step 3. Register the layer in `layers.csv`

Since we've created a whole new variable, we'll add a new row to `layers.csv`

We need to add content to the following columns:


 + **targets:** AO
 + **layer:** `ao_need_pov`
 + **name:** Add a longer title for the data layer--this will be displayed on your WebApp.
 + **description:** Add a longer description of the new data layer this will be displayed on your WebApp.
 + **fld_value:** percent
 + **units:** percent
 + **filename:** *ao_need_pov_blz2014.csv*
 + **fld_id_num:** *rgn_id*

## Step 4: Update AO model in `functions.r`

Update the model and how the function prepares for it

```
 layers_data = SelectLayersData(layers, targets='AO')
  
... 
->  Du = (1.0 - (need + need_pov)/2 ) * (1.0 - access)
    statusData = ((1.0 - Du) * Sustainability)
```


## Step 5: Check and possibly update `goals.csv`

Nothing to change in `goals.csv`.  

What you would look for: any variables in the *preindex_function* column


(Also, nothing to change in `pressures_matrix.csv` or `resilience_matrix.csv`)

## Step 6: Calculate scores; view with WebApp