# TODO:
# - use bibliography
# use title. problem now is that input md docs already using header 1

# load libraries ----
library(knitr)
library(rmarkdown)
library(stringr)

redo_website = F # T if do push update to ohi-science.org/manual; F if do not push. Displays T/F after rendering all


# copy ohimanual/README.md into ohimanual/content/README.md
stopifnot(file.copy('~/github/ohimanual/content/README.md', 
                    '~/github/ohimanual/README.md', overwrite=T))    

# set variables ----
title = 'The Ocean Health Index Assessment Manual'
wd = '~/github/ohimanual/content'

# Version below, June 12, 2015:

in_md = c(
  # 'README.md', # ---> Removed because covered in Conc. Guide; new portal
  #'3_what_is_OHI+.md', # --> masked 6/16/15
  '3_intro_assessment.md', # ready to push! 6/19
  # 'conduct_assessment.md', # --> Removed because sub-sections moved into appropriate Phases (see .md)
  #'before_conduct_assessment.md', # --> Removed because covered in Conc. Guide (see .md)
  '3_overview_webapp.md', # updated 6/18/15
  '3_gathering_appropriate_data.md', # newly updated (6/11/15)
  '3_intro_goalbygoal.md', # new(6/11/15)
  '3_practical_HAB_goals_CS_CP.md', # updated 6/11
  '3_practical_species_BDD_ICO.md', # updated 6/11
  '3_practical_SP.md', # updated 6/11
  '3_practical_FP_NP.md', # updated 6/17
  '3_practical_LE_TR.md', # updated 6/11
  '3_practical_AO.md', # updated 6/17
  '3_practical_CW.md', # updated 6/11
  '3_pressures_resilience.md', # --> Updated with practical guidance
  '3_intro_to_tbx.md', # updated 6/4, 6/12
  '3_file_system.md', # updated 6/4, 6/12
  '3_formatting_data.md',
  '3_data_transformation.md', # in development, needs more content from @katlongo
  '3_install_tbx.md', # updated 6/4, 6/12; in development;
  '3_accessing_github_repos.md',
  '3_github_architecture.md',
  '3_use_tbx.md', # updated 6/10; in development with new images; 
  '3_use_tbx_to_modify_data_layers.md',
  '3_use_tbx_to_modify_pressures_resilience.md',
  '3_use_tbx_to_modify_goal_models.md',
  '3_use_tbx_to_modify_goal_models_practical.md', # --> Exists, add more
  '3_use_tbx_to_remove_goal_models.md',
  '3_use_tbx_to_modify_goals_categories.md',
  '3_example_modifications_with_tbx.md',
  '3_frequently_asked_questions.md', # --> To be updated
  '3_toolbox_troubleshooting.md')
out_md = 'ohi-manual.md'

# Version below, April 15, 2015:

# in_md = c(
#   'README.md',
#   'intro_assessment.md',
#   'overview_webapp.md',
#   'before_conduct_assessment.md',
#   'conduct_assessment.md',
#   'gathering_appropriate_data.md',
#   'pressures_resilience.md',
#   'intro_to_tbx.md',
#   'file_system.md',
#   'formatting_data.md',
#   'install_tbx.md',
#   'accessing_github_repos.md',
#   'github_architecture.md',
#   'use_tbx.md',
#   'use_tbx_to_modify_data_layers.md',
#   'use_tbx_to_modify_pressures_resilience.md',
#   'use_tbx_to_modify_goal_models.md',
#   'use_tbx_to_remove_goal_models.md',
#   'use_tbx_to_modify_goals_categories.md',
#   'example_modifications_with_tbx.md',
#   'frequently_asked_questions.md',
#   'toolbox_troubleshooting.md')
# out_md = 'ohi-manual.md'

# cleanup original ----

## rename some .md files
for (f in list.files(getwd(), glob2rx('*.md'))){

  s = readLines(f, warn=F, encoding='UTF-8')
  # s = str_replace_all(s, fixed('using_the_ohi_toolbox_app.md'), fixed('toolbox_app_overview.md'))
  # s = str_replace_all(s, fixed('accessing_a_repo_without_GitHub.md'), fixed('accessing_a_repo_without_github.md'))
  # s = str_replace_all(s, fixed('accessing_a_repo.md'), fixed('accessing_a_repo_with_github.md'))
  # s = str_replace_all(s, fixed('calculate_regional_assessment_score.md'), fixed('use_tbx_regional_assessment.md'))
  # s = str_replace_all(s, fixed('regional_assessments_intro.md'), fixed('conduct_regional_assessment.md'))
  # s = str_replace_all(s, fixed('conduct_regional_assessment.md'), fixed('regional_assessments_intro.md'))
  # s = str_replace_all(s, fixed('regional_assessments_intro.md'), fixed('regional_assessment_intro.md'))
  # s = str_replace_all(s, fixed('github_repos.md'), fixed('install_tbx_regional_assessment.md'))
  # s = str_replace_all(s, fixed('toolbox_app_overview.md'), fixed('overview_toolbox_app.md'))
  s = str_replace_all(s, fixed('regional_assessment_intro.md'), fixed('intro_regional_assessment.md'))
  writeLines(s, f)
}



# rename *.png
setwd('~/github/ohimanual/content/fig')
for (f in list.files(getwd(), glob2rx('zfig_*'))){
  file.rename(f, str_replace(f, 'zfig_',''))
}
# update fig paths in *.md
setwd(wd)
for (f in list.files(getwd(), glob2rx('*.md'))){

  s = readLines(f, warn=F, encoding='UTF-8')
  s = str_replace_all(s, fixed('](zfig_'), fixed('](./fig/'))
  writeLines(s, f)

}

# move contents of /toolbox_manual/ folder out
for (f in list.files(getwd(), glob2rx('*.md'))){

  s = readLines(f, warn=F, encoding='UTF-8')
  s = str_replace_all(s, fixed('/toolbox_manual/'), fixed('/'))
  writeLines(s, f)

}


# helper functions ----
cat_md = function(
  files_md = setdiff(list.files(getwd(), glob2rx('*.md')), out_md),
  out_md  = '_all_.md'){

  if (file.exists(out_md)) unlink(out_md)

  cat('---\n', 'title: ', title, '\n---\n\n', sep='', file=out_md, append=T)

  for (md in files_md){
    cat(paste(c(readLines(md),'',''), collapse='\n'), file=out_md, append=T)
  }
}

# concatenate md ----
setwd(wd)
#cat_md()                           # use default file listing of *.md, default output _all_.md
#cat_md(md_order)                   # use own md ordered file listing , default output _all_.md
cat_md(in_md, out_md)               # use own md ordered file listing , output to ohi-manual.md
pfx = tools::file_path_sans_ext(out_md)

# render html ----
render(
  out_md,
  html_document(
    number_sections=T, fig_width = 3, fig_height = 2, fig_retina = 2, fig_caption = T, smart=T,
    self_contained=F, theme='default',
    highlight='default', mathjax='default', template='default',
    toc=T, toc_depth=3),
  clean=T, quiet=F,
  output_file = paste0(pfx, '.html'))
cat(sprintf('---
layout: page
title : Manual
tagline: %s
header : The Ocean Health Index Assessment Manual
group: navigation
---
{%s include JB/setup %s}
', format(Sys.time(), "%d %B %Y"), '%', '%'), file='~/github/ohi-science.github.io/manual/index.html')
cat(
  readLines(paste0(pfx, '.html')),
  file='~/github/ohi-science.github.io/manual/index.html',
  append=T)
# #file.copy(paste0(pfx, '.html'), '~/github/ohi-science.github.io/manual/index.html', overwrite=T)
if (redo_website) {
  dir.create('~/github/ohi-science.github.io/manual/fig', showWarnings=F)
  file.copy('fig', '~/github/ohi-science.github.io/manual', overwrite=T, recursive=T)
  system('cd ~/github/ohi-science.github.io; git pull; git add -A; git commit -m "update manual"; git push')
}

## to resize already existing figures. Check folder paths.
# dir.create('~/github/ohimanual/content/fig/_resized', showWarnings=F)
# for (f in list.files('~/github/ohimanual/content/fig/_originals','*.\\.png$')){ # f = list.files('~/github/ohimanual/content/fig','*.\\.png$')[1]
#   f_old = file.path('~/github/ohimanual/content/fig/_originals', f)
#   f_new = file.path('~/github/ohimanual/content/fig/_resized', f)
#   dpi = 72
#   width_in = 10
#   height_in = 6
#   if (!file.exists(f_new)){
#     system(sprintf("convert -density %d -resize '%dx%d' %s %s", dpi, width_in * dpi, height_in * dpi, f_old, f_new))
#   }
# }


# render docx ----
render(
  out_md,
  word_document(
    fig_caption = T, fig_width = 7, fig_height = 5,
    highlight='default', reference_docx='default'),
  clean=T, quiet=F,
  output_file = paste0(pfx, '.docx'))

# render pdf ----
render(
  out_md,
  pdf_document(
    toc = T, toc_depth = 4, number_sections = T,
    fig_width = 6.5, fig_height = 4.5, fig_crop = TRUE,
    fig_caption = T, highlight = "default", template = "default",
    keep_tex = F, latex_engine = "pdflatex",
    includes = NULL, pandoc_args = NULL),
  clean=T, quiet=F,
  output_file = paste0(pfx, '.pdf'))


# message regarding redo_website ----

print(sprintf('ohi-science.org/manual was updated: %s', redo_website))
if(redo_website ==F) print("to update ohi-science.org/manual, change the 'redo_website' variable from FALSE to TRUE")
